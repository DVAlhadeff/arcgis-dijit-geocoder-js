<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>

    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=7, IE=9" />
        <!--The viewport meta tag is used to improve the presentation and behavior
        of the samples on iOS devices-->
        <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no"
        />
        <title></title>
        <link rel="stylesheet" type="text/css" href="http://servicesbeta.esri.com/jsapi/arcgis/3.3/js/dojo/dijit/themes/soria/soria.css">
        <link rel="stylesheet" type="text/css" href="http://servicesbeta.esri.com/jsapi/arcgis/3.3/js/esri/css/esri.css">
        <link rel="stylesheet" type="text/css" href="css/Geocoder.css">
        <style type="text/css">
            html, body, #map {
                height:100%;
                width:100%;
                margin:0;
                padding:0;
            }
            body {
                background-color:#FFF;
                overflow:hidden;
                font-family:"Trebuchet MS";
            }
            #search {
                display: block;
                position: absolute;
                z-index: 3;
                top: 20px;
                left: 75px;
            }
            .spotlight {
                z-index:-1;
                position:absolute;
                left:50%;
                top:50%;
                border-radius:50%;
                opacity:0;
                box-shadow:
                inset rgba(0,0,0,0.25) 0px 0px 20px 20px,
                rgba(0,0,0,0.25) 0px 0px 0px 1000px;
                transition:all 1000ms;
                -moz-transition:all 1000ms;
                -webkit-transition:all 1000ms;
            }
            .spotlight-active {
                z-index:2;
                opacity:1;
            }
        </style>
        <script type="text/javascript">
            // host path regular expression
            var pathRegex = new RegExp(/\/[^\/]+$/);
            var locationPath = location.pathname.replace(pathRegex, '');
            // Dojo Config
            var dojoConfig = {
                parseOnLoad: true,
                packages: [
                {
                    name: "modules",
                    location: locationPath + 'src'
                }]
            };
        </script>
        <script src="http://servicesbeta.esri.com/jsapi/arcgis/3.3"></script>
        <script type="text/javascript">
        require([
            "dojo/ready",
            "dojo/dom",
            "dojo/dom-construct",
            "dojo/query",
            "dojo/_base/Color",
            "dojo/_base/connect",
            "modules/Geocoder",
            "esri",
            "esri/map",
            "esri/IdentityManager",
            "esri/arcgis/utils"
        ],
        function (ready, dom, domConstruct, query, Color, connect, Geocoder, esri) {

            var map;
            var myGeocoder;

            function resizeMap() {
                map.resize();
                map.reposition();
            }

            function init(){

                var extent = esri.geometry.Extent({
                    xmax: -7856121.865955909,
                    xmin: -8626607.111070449,
                    ymax: 5442390.7902907785,
                    ymin: 4729386.19044669,
                    spatialReference: map.extent.spatialReference
                });
                map.setExtent(extent);

                var html = '<div id="spotlight" class="spotlight"></div>';

                domConstruct.place(html, dom.byId('map_container'), 'first');


                //resize the map when the browser resizes
                connect.connect(dijit.byId('map'), 'resize', map, map.resize);
                connect.connect(window, "onresize", resizeMap);

                connect.connect(map, 'onExtentChange', function(){
                    removeSpotlight();
                });

                // Geocoder with all common options set. Only map is required.
                myGeocoder = new Geocoder({
                    autoComplete: true,
                    arcgisGeocoder: {
                        url: 'http://geocodedev.arcgis.com/arcgis/rest/services/World/GeocodeServer',
						localSearchOptions: {
							minScale: 0,
							distance: 2000
						}
                    },
                    geocoders:[
                        {
                             url: 'http://geocodedev.arcgis.com/arcgis/rest/services/World/GeocodeServer',
                             singleLineFieldName: 'singleLine',
                             name: 'geo2'
                        }
                    ],
                    map: map
                }, dom.byId('search'));

				// start widget
				myGeocoder.startup();

				// on search results
				connect.connect(myGeocoder, 'onSearchResults', function(results){
					console.log('search', results);
				});

				// on search results
				connect.connect(myGeocoder, 'onGeocoderSelect', function(results){
					console.log('onselect', results);
				});

				// on search results
				connect.connect(myGeocoder, 'onAutoComplete', function(results){
					console.log('autocomplete', results);
				});

				// on params
				connect.connect(myGeocoder, 'setGeocoderParams', function(params){
					console.log('params', params);
				});


				function removeSpotlight(){
					query('.spotlight').removeClass('spotlight-active');
			        map.graphics.clear();
				}

				// on select test
				connect.connect(myGeocoder, 'onSelect', function(result){

				    var spotlight = connect.connect(map, 'onExtentChange', function(){
                        var geom = esri.geometry.toScreenGeometry(map.extent, map.width, map.height, result.extent);
                        var width = geom.xmax - geom.xmin;
                        var height = geom.ymin - geom.ymax;

                        var max = height;
                        if(width > height){
                            max = width;
                        }

                        var margin = '-' + Math.floor(max/2) + 'px 0 0 -' + Math.floor(max/2) + 'px';

                        var pt = result.feature.geometry;
                        var sms = new esri.symbol.SimpleMarkerSymbol().setStyle(
                        esri.symbol.SimpleMarkerSymbol.STYLE_SQUARE).setColor(
                        new Color([255,0,0,0.5]));
                        var graphic = new esri.Graphic(pt,sms,null,null);

                        map.graphics.add(graphic);

                        query('.spotlight').addClass('spotlight-active').style({
                            width: max + 'px',
                            height: max + 'px',
                            margin: margin
                        });
                        connect.disconnect(spotlight);
                    });


				});

				// on clear test
				connect.connect(myGeocoder, 'onClear', function(){
			        removeSpotlight();
			    });
            }

            ready(function () {
                esri.config.defaults.io.proxyUrl = "/arcgisserver/apis/javascript/proxy/proxy.ashx";
                //This service is for development and testing purposes only. We recommend that you create your own geometry service for use within your applications.
                esri.config.defaults.geometryService = new esri.tasks.GeometryService("http://tasks.arcgisonline.com/ArcGIS/rest/services/Geometry/GeometryServer");

                var urlObject = esri.urlToObject(document.location.href);
                var webmap = "6e03e8c26aad4b9c92a87c1063ddb0e3";
                var bingMapsKey = "Enter your Bing Maps Key";
                if (urlObject.query) {
                    webmap = urlObject.query.webmap;
                    bingMapsKey = urlObject.query.bingMapsKey;
                }

                var mapDeferred = esri.arcgis.utils.createMap(webmap, "map", {
                    mapOptions: {
                        slider: true,
                        sliderStyle: 'small'
                    },
                    bingMapsKey: bingMapsKey,
                    geometryServiceURL: "http://tasks.arcgisonline.com/ArcGIS/rest/services/Geometry/GeometryServer"
                });
                mapDeferred.addCallback(function (response) {
                    map = response.map;
                    if(map.loaded){
                        init();
                    }
                    else{
                        connect.connect(map, "onload", init);
                    }
                    //resize the map when the browser resizes
                    connect.connect(dijit.byId('map'), 'resize', map, map.resize);
                    connect.connect(window, "onresize", resizeMap);
                });
                mapDeferred.addErrback(function (error) {
                    console.log("Map creation failed" + error.toString());
                });
            });
        });
        </script>
    </head>
    <body dir="" class="soria">
        <div id="search"></div>
        <div dir="ltr" id="map"></div>
    </body>
</html>