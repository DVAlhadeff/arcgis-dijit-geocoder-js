<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>

    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=7, IE=9" />
        <!--The viewport meta tag is used to improve the presentation and behavior
        of the samples on iOS devices-->
        <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no"
        />
        <title></title>
        <link rel="stylesheet" type="text/css" href="http://servicesbeta.esri.com/jsapi/arcgis/3.3/js/dojo/dijit/themes/soria/soria.css">
        <link rel="stylesheet" type="text/css" href="http://servicesbeta.esri.com/jsapi/arcgis/3.3/js/esri/css/esri.css">
        <link rel="stylesheet" type="text/css" href="css/Geocoder.css">
        <style type="text/css">
            html, body, #map {
                height:100%;
                width:100%;
                margin:0;
                padding:0;
            }
            body {
                background-color:#FFF;
                overflow:hidden;
                font-family:"Trebuchet MS";
            }
            #search {
                display: block;
                position: absolute;
                z-index: 3;
                top: 20px;
                left: 75px;
            }
            .spotlight {
                z-index:-1;
                position:absolute;
                left:50%;
                top:50%;
                border-radius:50%;
                opacity:0;
                box-shadow:
                inset rgba(0,0,0,0.25) 0px 0px 20px 20px,
                rgba(0,0,0,0.25) 0px 0px 0px 1000px;
                transition:all 1000ms;
                -moz-transition:all 1000ms;
                -webkit-transition:all 1000ms;
            }
            .spotlight-active {
                z-index:2;
                opacity:1;
            }
        </style>
        <script type="text/javascript">
            // host path regular expression
            var pathRegex = new RegExp(/\/[^\/]+$/);
            var locationPath = location.pathname.replace(pathRegex, '');
            // Dojo Config
            var dojoConfig = {
                //locale: "ar",
                parseOnLoad: true
            };
        </script>
        <script src="http://servicesbeta.esri.com/jsapi/arcgis/3.3"></script>
        <script type="text/javascript" src="js/Geocoder.js"></script>
        <script type="text/javascript">

            dojo.require("esri.map");
            dojo.require("esri.IdentityManager");
            dojo.require("esri.arcgis.utils");


            var map;
            var Geocoder;

            function init() {
                esri.config.defaults.io.proxyUrl = "/arcgisserver/apis/javascript/proxy/proxy.ashx";
                //This service is for development and testing purposes only. We recommend that you create your own geometry service for use within your applications.
                esri.config.defaults.geometryService = new esri.tasks.GeometryService("http://tasks.arcgisonline.com/ArcGIS/rest/services/Geometry/GeometryServer");

                var urlObject = esri.urlToObject(document.location.href);
                var webmap = "31075fa2763f43bba0c2163814cc44aa";
                var bingMapsKey = "Enter your Bing Maps Key";
                if (urlObject.query) {
                    webmap = urlObject.query.webmap;
                    bingMapsKey = urlObject.query.bingMapsKey;
                }

                var mapDeferred = esri.arcgis.utils.createMap(webmap, "map", {
                    mapOptions: {
                        slider: true,
                        sliderStyle: 'small'
                    },
                    bingMapsKey: bingMapsKey,
                    geometryServiceURL: "http://tasks.arcgisonline.com/ArcGIS/rest/services/Geometry/GeometryServer"
                });
                mapDeferred.addCallback(function (response) {
                    map = response.map;

                    var html = '<div id="spotlight" class="spotlight"></div>';

                    dojo.place(html, dojo.byId('map_container'), 'first');


                    //resize the map when the browser resizes
                    dojo.connect(dijit.byId('map'), 'resize', map, map.resize);
                    dojo.connect(window, "onresize", resizeMap);

                    dojo.connect(map, 'onExtentChange', function(){
                        removeSpotlight();
                    });

                    // Geocoder with all common options set. Only map is required.
                    Geocoder = new esri.dijit.Geocoder({
                        autoComplete: true,
                        arcgisGeocoder: {
                            url: 'http://geocodedev.arcgis.com/arcgis/rest/services/World/GeocodeServer',
							localSearchOptions: {
								minScale: 0,
								distance: 2000
							}
                        },
                        map: map
                    }, dojo.byId('search'));

					// start widget
					Geocoder.startup();

					// on search results
					dojo.connect(Geocoder, 'onSearchResults', function(results){
    					console.log('search', results);
					});

					// on search results
					dojo.connect(Geocoder, 'onGeocoderSelect', function(results){
    					console.log('onselect', results);
					});

					// on search results
					dojo.connect(Geocoder, 'onAutoComplete', function(results){
    					console.log('autocomplete', results);
					});


					function removeSpotlight(){
    					dojo.query('.spotlight').removeClass('spotlight-active');
				        map.graphics.clear();
					}

					// on select test
					dojo.connect(Geocoder, 'onSelect', function(result){


					    var spotlight = dojo.connect(map, 'onExtentChange', function(){
                            var geom = esri.geometry.toScreenGeometry(map.extent, map.width, map.height, result.extent);
                            var width = geom.xmax - geom.xmin;
                            var height = geom.ymin - geom.ymax;

                            var max = height;
                            if(width > height){
                                max = width;
                            }

                            var margin = '-' + Math.floor(max/2) + 'px 0 0 -' + Math.floor(max/2) + 'px';

                            var pt = result.feature.geometry;
                            var sms = new esri.symbol.SimpleMarkerSymbol().setStyle(
                            esri.symbol.SimpleMarkerSymbol.STYLE_SQUARE).setColor(
                            new dojo.Color([255,0,0,0.5]));
                            var graphic = new esri.Graphic(pt,sms,null,null);

                            map.graphics.add(graphic);

                            dojo.query('.spotlight').addClass('spotlight-active').style({
                                width: max + 'px',
                                height: max + 'px',
                                margin: margin
                            });
                            dojo.disconnect(spotlight);
                        });


					});

					// on clear test
					dojo.connect(Geocoder, 'onClear', function(){
				        removeSpotlight();
				    });

                });
                mapDeferred.addErrback(function (error) {
                    console.log("Map creation failed: ", dojo.toJson(error));
                });

            }

            function resizeMap() {
                map.resize();
                map.reposition();
            }

            //show map on load
            dojo.addOnLoad(init);
        </script>
    </head>

    <body dir="" class="soria">
        <div id="search"></div>
        <div dir="ltr" id="map"></div>

    </body>

</html>